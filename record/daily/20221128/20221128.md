
Daily Record 20221128
=====================

## 流水

实验指导书；



## 知识点

##### 执行环境的功能：

1. 执行它支持的上层软件之前进行一些初始化工作；
2. 对上层软件的执行进行监控管理；

##### 特权级切换带来的异常控制流Exception Control Flow原因有二：

1. 用户态软件为获得内核态操作系统的服务功能而执行特殊指令（**异常不一定是错误**）；
2. 执行某条指令期间产生了错误并被CPU检测到；

##### **Trap**（陷入）：有意为之的**异常**指令：

1. Breakpoint

2. Enviroment Call（执行环境调用）

   不同特权级模式之间的接口正是通过ecall实现，称为**系统调用**syscall，有SBI，ABI等

##### 二进制接口

不同于高级编程语言的内部调用接口，是机器/汇编指令级的一种接口。不同特权级软件可以由不同编程语言实现，即便是同一种语言，其调用并非普通函数调用控制流，而是**陷入异常控制流**，该过程中会切换CPU特权级，因此只有将接口下降到**机器/汇编指令级**才能满足其**跨高级语言**的通用性和灵活性。

##### CSR(Control and Status Register)

每个特权级都有自己对应的CSR

##### 通用寄存器x0-x31

任何特权级都可以执行；

`x10~x17`：对应`a0-a7`

`x1`：对应`ra`

##### 系统调用syscall

实际上是汇编指令级的二进制接口

##### RSIC-V调用规范

和函数调用的ABI情形类似，约定寄存器：

1. `a0-a6`保存系统调用的参数；
2. `a0`保存系统调用的返回值；
3. `a7`用来传递syscall ID

##### 寄存器可以理解为内存

csr/reg  可以理解为就是一种特殊的内存，但是

1. 有自己各自的地址空间
2. 根据规范，会被硬件或其他软件自动读写

比如 reg 的地址空间是 [0,31]，单位是 xlen 位。reg 会根据规范定义的调用约定，由编译器自动安排使用。

需要 csr/reg 在自己的地址空间，而不是全用内存，是因为这些地址空间更小，因此保证可以作为立即数放进 32 位的指令内部。而总线地址太宽，不可能放进指令里。除此之外，reg 和普通内存并没有本质区别。比如伪指令 mv a,b 把 b 寄存器的 xlen 位存入 a，指令 lw a,(b) 把 b 内存的 32 位存入 a，没有本质区别。

csr 除了有自己的小内存空间，有时候还会被硬件自动读写，或者在读写时触发硬件的一些操作。可以把硬件视作另一个软件（虚拟化的时候，比如 qemu，它确实是另一个软件）跟用户程序一样会根据规范和你的内核软件协作而已。

## 总结



## 下次学习入口

实验指导书：[实现批处理操作系统](http://rcore-os.cn/rCore-Tutorial-Book-v3/chapter2/3batch-system.html#term-batchos)；

##### [返回Home](../../../README.md)


